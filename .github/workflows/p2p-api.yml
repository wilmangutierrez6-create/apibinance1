name: Binance P2P Data Fetcher

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  fetch-p2p-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout c칩digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas ccxt

      - name: Crear carpetas necesarias
        run: |
          mkdir -p backend
          mkdir -p data

      - name: Crear script Python real
        run: |
          cat > backend/p2p-api.py << "EOF"
          #!/usr/bin/env python3
          import os, json, ccxt
          from datetime import datetime

          def fetch_binance_p2p():
              exchange = ccxt.binance({
                  'apiKey': os.environ.get("BINANCE_API_KEY"),
                  'secret': os.environ.get("BINANCE_API_SECRET"),
              })

              try:
                  # Traemos 100 칩rdenes para tener m치s historial de c치lculo
                  orders = exchange.sapi_get_c2c_ordermatch_listuserorderhistory({'tradeType': 'BOTH', 'rows': 100})
                  raw_orders = orders.get('data', [])
                  
                  # Paso 1: Separar compras de ventas para calcular costos
                  compras = [float(o['unitPrice']) for o in raw_orders if o['tradeType'] == 'BUY' and o['orderStatus'] == 'COMPLETED']
                  precio_promedio_compra = sum(compras) / len(compras) if compras else 0

                  processed_orders = []
                  for order in raw_orders:
                      if order['orderStatus'] == 'COMPLETED':
                          precio_actual = float(order['unitPrice'])
                          monto_total = float(order['totalPrice'])
                          
                          # Paso 2: Calcular ganancia estimada si es una VENTA
                          ganancia_estimada = 0
                          if order['tradeType'] == 'SELL' and precio_promedio_compra > 0:
                              # Ganancia = (Precio Venta - Precio Compra Promedio) * Cantidad
                              cantidad = float(order['amount'])
                              ganancia_estimada = (precio_actual - precio_promedio_compra) * cantidad

                          processed_orders.append({
                              "id": order['orderNumber'],
                              "fecha": datetime.fromtimestamp(int(order['createTime'])/1000).strftime('%Y-%m-%d'),
                              "activo": order['asset'],
                              "tipo": "COMPRA" if order['tradeType'] == 'BUY' else "VENTA",
                              "monto": monto_total,
                              "ganancia": round(ganancia_estimada, 2),
                              "estado": "COMPLETADO"
                          })

                  return {"success": True, "ultima_actualizacion": datetime.now().strftime('%Y-%m-%d %H:%M:%S'), "operaciones": processed_orders}
              except Exception as e:
                  print(f"Error: {e}")
                  return None

          datos = fetch_binance_p2p()
          if datos:
              with open('data/p2p-data.json', 'w', encoding='utf-8') as f:
                  json.dump(datos, f, indent=2)
          EOF

      - name: Ejecutar script
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
        run: python backend/p2p-api.py

      - name: Subir cambios al repositorio
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add data/p2p-data.json
          git commit -m "Actualizar datos P2P Reales - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No hay cambios"
          git push
