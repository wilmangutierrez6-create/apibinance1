name: Binance P2P Data Fetcher

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  fetch-p2p-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
    
     - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas ccxt
    
      - name: Crear carpetas necesarias
        run: |
          mkdir -p backend
          mkdir -p data
    # AQUÍ VA EL BLOQUE QUE PREGUNTASTE:
      - name: Crear script Python simplificado
        run: |
          cat > backend/p2p-api.py << "EOF"
          #!/usr/bin/env python3
          import os
          import json
          from datetime import datetime

          # 1. Obtener llaves (para uso futuro en la API real)
          api_key = os.environ.get("BINANCE_API_KEY")
          api_secret = os.environ.get("BINANCE_API_SECRET")

          # 2. Estructura de datos que espera tu script.js
          resultado = {
              "success": True,
              "ultima_actualizacion": datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
              "operaciones": [
                  {
                      "id": 1,
                      "fecha": datetime.now().strftime('%Y-%m-%d'),
                      "activo": "USDT",
                      "tipo": "VENTA",
                      "monto": 1500.00,
                      "ganancia": 25.50,
                      "estado": "COMPLETADO"
                  },
                  {
                      "id": 2,
                      "fecha": datetime.now().strftime('%Y-%m-%d'),
                      "activo": "BTC",
                      "tipo": "COMPRA",
                      "monto": 2500.00,
                      "ganancia": 40.20,
                      "estado": "COMPLETADO"
                  }
              ]
          }

          # 3. Guardar el archivo en la carpeta data/
          with open('data/p2p-data.json', 'w', encoding='utf-8') as f:
              json.dump(resultado, f, indent=2, ensure_ascii=False)

          print("✅ Archivo data/p2p-data.json generado con operaciones.")
          EOF

      - name: Ejecutar script con Secrets
        # ... (Sigue el resto del archivo)
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
        run: |
          echo "Ejecutando script..."
          python backend/p2p-api.py
    
      - name: Subir cambios al repositorio
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add data/p2p-data.json
          git commit -m "Actualizar datos P2P - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No hay cambios nuevos"
          git push
