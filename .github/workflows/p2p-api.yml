name: Binance P2P Data Fetcher

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  fetch-p2p-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
    
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas
    
      - name: Crear carpetas necesarias
        run: |
          mkdir -p backend
          mkdir -p data
    
      - name: Crear script Python simplificado
        run: |
          cat > backend/p2p-api.py << 'EOF'
#!/usr/bin/env python3
print("Script P2P de Binance")
import os
import json
from datetime import datetime

# Verificar secrets
api_key = os.environ.get("BINANCE_API_KEY")
api_secret = os.environ.get("BINANCE_API_SECRET")

print(f"API_KEY: {'âœ…' if api_key else 'âŒ'}")
print(f"API_SECRET: {'âœ…' if api_secret else 'âŒ'}")

# Crear datos de prueba
resultado = {
    "success": True,
    "timestamp": datetime.now().isoformat(),
    "message": "Script ejecutado correctamente",
    "api_key_presente": bool(api_key),
    "api_secret_presente": bool(api_secret),
    "ultima_actualizacion": datetime.now().strftime('%Y-%m-%d %H:%M:%S')
}

# Guardar resultados
with open('data/p2p-data.json', 'w', encoding='utf-8') as f:
    json.dump(resultado, f, indent=2, ensure_ascii=False)

print("âœ… Datos guardados en data/p2p-data.json")
EOF
    
      - name: Verificar script creado
        run: |
          echo "ðŸ“„ Verificando script Python:"
          ls -la backend/p2p-api.py
          echo "Primeras 5 lÃ­neas:"
          head -5 backend/p2p-api.py
    
      - name: Ejecutar script con Secrets
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
        run: |
          echo "ðŸ”§ Variables de entorno:"
          echo "BINANCE_API_KEY: $(if [ -z "$BINANCE_API_KEY" ]; then echo 'NO CONFIGURADO'; else echo 'CONFIGURADO (${#BINANCE_API_KEY} caracteres)'; fi)"
          echo "BINANCE_API_SECRET: $(if [ -z "$BINANCE_API_SECRET" ]; then echo 'NO CONFIGURADO'; else echo 'CONFIGURADO (${#BINANCE_API_SECRET} caracteres)'; fi)"
          echo ""
          echo "ðŸš€ Ejecutando script..."
          python backend/p2p-api.py
    
      - name: Verificar resultado
        run: |
          echo "ðŸ“Š Verificando resultados..."
          if [ -f "data/p2p-data.json" ]; then
            echo "âœ… Archivo creado exitosamente"
            cat data/p2p-data.json
          else
            echo "âŒ Error: No se creÃ³ el archivo"
            exit 1
          fi
    
      - name: Subir cambios al repositorio
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add data/p2p-data.json
          git commit -m "ðŸ“Š Actualizar datos P2P - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No hay cambios nuevos"
          git push
